<root BTCPP_format="4" >
   <include path="./cam_find_and_track_ball.xml" />
   <include path="./locate.xml" />
   <include path="./find_ball.xml" />
   
   <BehaviorTree ID="Defender">
      <ReactiveSequence>
         <!-- 자기 위치 추정 -->
         <SelfLocate mode="trust_direction" />
         
         <!-- 공 위치 알 때만 로컬라이제이션 -->
         <SubTree ID="Locate" _autoremap="true" _while="decision!='find'" />
         
         <ReactiveSequence name="정상 경기">
            
            <!-- 공이 아웃된 경우 -->
            <Sequence _while="ball_out">
               <SubTree ID="CamFindAndTrackBall" _autoremap="true" />
               <GoBackInField />
               <SubTree ID="Locate" _autoremap="true" _while="decision!='find'" />
            </Sequence>
            
            <!-- 공이 인플레이 -->
            <ReactiveSequence _while="!ball_out">
               <ReactiveSequence>
                  <!-- 공 추적 -->
                  <SubTree ID="CamFindAndTrackBall" _autoremap="true" />
                  
                  <!-- 킥 방향 계산 -->
                  <CalcKickDir cross_threshold="0.5" />
                  
                  <Sequence>
                     <!-- 의사결정: DefenderDecide 사용 -->
                     <ReactiveSequence>
                        <DefenderDecide decision_out="{decision}" decision_in="{decision}" chase_threshold="1.0" />
                        
                        <!-- 공 찾기 -->
                        <SubTree ID="FindBall" _while="decision=='find'" _autoremap="true" />
                     </ReactiveSequence>
                     
                     <!-- 행동 실행 -->
                     
                     <!-- Chase (비슷하게) -->
                     <Chase _while="decision == 'chase'" vx_limit="0.9" vy_limit="0.2" vtheta_limit="1.0" dist="0.1" safe_dist="0.5" />
                     
                     <!-- Adjust -->
                     <Adjust _while="decision == 'adjust'" turn_threshold="0.5" range="0.4" vx_limit="0.7" vy_limit="0.6" vtheta_limit="1.5" vtheta_factor="1.5" tangential_speed_far="0.7" tangential_speed_near="0.15" />
                     
                     <!-- Kick (패스/걷어내기) -->
                     <Kick _while="decision == 'kick'" speed_limit="1.0" min_msec_kick="1000" msecs_stablize="1000" />
                     
                     <!-- Assist (대기/복귀) -->
                     <Sequence _while="decision == 'assist'">
                        <SetVelocity /> 
                        <!-- 추후 GoToRolePosition 등으로 대체 가능 -->
                     </Sequence>

                  </Sequence>
               </ReactiveSequence>
            </ReactiveSequence>
         </ReactiveSequence>
      </ReactiveSequence>
   </BehaviorTree>
</root>
