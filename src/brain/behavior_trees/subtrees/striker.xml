<root BTCPP_format="4" >
   <include path="./cam_find_and_track_ball.xml" />
   <include path="./locate.xml" />
   <include path="./find_ball.xml" />
   
   <BehaviorTree ID="Striker">
      <ReactiveSequence>
         <!-- 자기 위치 추정 -->
         <SelfLocate mode="trust_direction" />
         
         <!-- 공 위치 알 때만 로컬라이제이션(공 위치에 대한 find상태가 아님을 의미)-->
         <SubTree ID="Locate" _autoremap="true" _while="decision!='find'" />
         
         <!-- 상대 킥오프 대기 -->
         <ReactiveSequence _while="wait_for_opponent_kickoff" name="상대 팀 킥오프 대기">
            <SubTree ID="CamFindAndTrackBall" _autoremap="true" />
            <SetVelocity />
         </ReactiveSequence>
         
         <!-- 정상 경기 -->
         <ReactiveSequence _while="!wait_for_opponent_kickoff" name="정상 경기">
            
            <!-- 공이 아웃된 경우 -->
            <Sequence _while="ball_out">
               <SubTree ID="CamFindAndTrackBall" _autoremap="true" />
               <GoBackInField />
               <SubTree ID="Locate" _autoremap="true" _while="decision!='find'" />
            </Sequence>
            
            <!-- 공이 인플레이 -->
            <ReactiveSequence _while="!ball_out">
               <ReactiveSequence>
                  <!-- 공 추적 -->
                  <SubTree ID="CamFindAndTrackBall" _autoremap="true" />
                  
                  <!-- 킥 방향 개선 (골키퍼 고려) -->
                  <CalcKickDir />
                  <!-- <CalcKickDirWithGoalkeeper cross_threshold="0.5" goalkeeper_margin="0.53" /> -->
                  
                  <Sequence>
                     
                     <ReactiveSequence>
                        <StrikerDecide decision_out="{decision}" decision_in="{decision}" chase_threshold="0.85" kick_y_offset="-0.05" set_piece_goal_dist="2.0" />
                        
                        <!-- 공 찾기 -->
                        <SubTree ID="FindBall" _while="decision=='find'" _autoremap="true" />
                     </ReactiveSequence>
                     
                     <!-- 행동 실행 -->
                     <!-- TODO 3 : Assist는 Communication 검증 후 추가 -->
                     <!-- <Assist _while="decision == 'assist'" vx_limit="0.2" vy_limit="0.2" /> -->

                     <!-- Dribble To Goal -->
                     <DribbleToGoal _while="decision == 'dribble'" vx_limit="1.0" vy_limit="0.5" vtheta_limit="1.0" dist_to_goal="2.5" min_speed="0.2" max_speed="0.8" slow_dist_far="0.4" circle_back_dist="0.7" />
                     
                     <!-- Off the ball -->
                     <OfftheballPosition _while="decision == 'offtheball'" dist_from_goal="1.0" />

                     <!-- Chase -->
                     <Chase _while="decision == 'chase'" vx_limit="0.9" vy_limit="0.2" vtheta_limit="1.0" dist="0.4" safe_dist="1.0" />

                     <!-- Adjust -->
                     <Adjust _while="decision == 'adjust'" no_turn_threshold="0.01" turn_threshold="0.5" turn_first_threshold="0.5" range="0.6" vx_limit="0.5" vy_limit="0.5" vtheta_limit="1.0" vtheta_factor="1.5" tangential_speed_far="0.5" tangential_speed_near="0.02" near_threshold="0.3" kick_y_offset="-0.05" />
                     
                     <!-- Adjust: adjust_quick -->
                     <Adjust _while="decision == 'adjust_quick'" no_turn_threshold="0.1" turn_threshold="0.5" turn_first_threshold="0.5" range="0.6" vx_limit="1.0" vy_limit="0.3" vtheta_limit="1.0" vtheta_factor="2.0" tangential_speed_far="0.5" tangential_speed_near="0.4" near_threshold="0.4" kick_y_offset="-0.05" />
                     
                     <!--
                     no_turn_threshold     : 0.1, "각도 오차가 이 값보다 작으면 회전을 수행하지 않는다"
                     turn_threshold        : 3.25, "공의 각도가 이 값보다 크면 먼저 회전하여 공을 정면으로 바라보고 이동은 중단한다" -> 사용중 x
                     turn_first_threshold  : 0.5, "각도 오차가 이 값보다 크면 이동하지 않고 회전만 먼저 수행한다"
                     range                 : 2.25, "공과 로봇 사이의 목표 거리로 이 값을 유지하려고 한다"
                     vx_limit              : 0.05, "Adjust 과정에서 전진/후진 속도 vx의 최대 제한값이다"
                     vy_limit              : 0.05, "Adjust 과정에서 좌우 이동 속도 vy의 최대 제한값이다"
                     vtheta_limit          : 0.1, "Adjust 과정에서 회전 속도 vtheta의 최대 제한값이다"
                     vtheta_factor         : 3.0, "각도 보정 시 vtheta에 곱해지는 계수로 클수록 회전이 빠르다"
                     tangential_speed_far  : 0.2, "공이 멀 때 각도 보정을 위해 사용하는 접선 방향 이동 속도이다"
                     tangential_speed_near : 0.15, "공이 가까울 때 각도 보정을 위해 사용하는 접선 방향 이동 속도이다"
                     near_threshold        : 0.8, "목표와의 거리가 이 값보다 작으면 near speed를 사용한다"
                     kick_y_offset         : -0.13, "킥 시 공을 로봇 중심에서 y축으로 얼마나 오프셋 시킬지 결정" -> 현재 오른발 강제
                     -->

                     <!-- 일반 킥 -->
                     <Kick _while="decision == 'kick'" speed_limit="1.3" vx_limit="1.3" vy_limit="0.3" min_msec_kick="1000" msecs_stablize="1000" kick_type="kick" kick_y_offset="-0.05" />

                     <!-- 빠른 킥 -->
                     <Kick _while="decision == 'kick_quick'" speed_limit="1.3" vx_limit="1.3" vy_limit="0.5" min_msec_kick="300" msecs_stablize="100" kick_type="kick" kick_y_offset="-0.05" />
                     
                     <!-- Cross (측면 패스) -->
                     <!-- <Kick _while="decision == 'cross'" speed_limit="0.4" min_msec_kick="300" kick_type="cross" /> -->

                  </Sequence>
               </ReactiveSequence>
            </ReactiveSequence>
         </ReactiveSequence>
      </ReactiveSequence>
   </BehaviorTree>
</root>
